#!/usr/bin/env bash

# Configuration
WALLPAPER_DIR="$HOME/Pictures/wallpapers"
CACHE_DIR="$HOME/.cache/wallpaper-thumbnails"

# Create cache directory
mkdir -p "$CACHE_DIR"

# Get wallpapers
mapfile -t wallpapers < <(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \))

# Prepare rofi input
rofi_input=""
for wall in "${wallpapers[@]}"; do
    filename=$(basename "$wall")
    thumb="$CACHE_DIR/$filename.png"
    
    # Generate thumbnail using IMv7 'magick'
    if [[ ! -f "$thumb" ]]; then
        # This creates a cropped square preview for a clean grid
        magick "$wall" -thumbnail 256x256^ -gravity center -extent 256x256 "$thumb"
    fi
    
    rofi_input+="$filename\x00icon\x1f$thumb\n"
done

# Run rofi with gallery view
# IMPORTANT: -show-icons must be present
selected_name=$(echo -e "$rofi_input" | rofi -dmenu -i -p "Wallpaper" \
    -show-icons \
    -theme-str '
        configuration { show-icons: true; }
        window { width: 50%; }
        listview { columns: 3; lines: 3; spacing: 20px; }
        element { orientation: vertical; padding: 15px; }
        element-icon { size: 150px; horizontal-align: 0.5; }
        element-text { horizontal-align: 0.5; vertical-align: 0.5; }
    ')
if [[ -n "$selected_name" ]]; then
    FULL_PATH="$WALLPAPER_DIR/$selected_name"

    # Kill old instances
    pkill swaybg

    # Apply wallpaper
    swaybg -i "$FULL_PATH" -m fill &

    # Generate theme colors based on the new wallpaper
    ~/.local/bin/theme-generator.sh "$FULL_PATH"
    nvim --server /tmp/nvim-matugen --remote-send '<cmd>lua ReloadMatugen()<CR>'

fi
